{% load static %}

<div class="audio-player card bg-dark text-light mb-3">
    <div class="card-body">
        <h5 class="card-title">{{ demo.title }}</h5>
        
        {% if demo.audio_file %}
            <div class="waveform-container mb-3" id="waveform-{{ demo.id }}">
                <!-- Il waveform verrÃ  renderizzato qui -->
            </div>
            
            <audio id="audio-{{ demo.id }}" class="w-100" controls>
                <source src="{{ demo.audio_file.url }}" type="audio/mpeg">
                Il tuo browser non supporta l'elemento audio.
            </audio>
            
            {% if demo.waveform_data %}
                <script>
                    document.addEventListener('DOMContentLoaded', function() {
                        const waveformData = {{ demo.waveform_data|safe }};
                        const container = document.getElementById('waveform-{{ demo.id }}');
                        
                        // Crea il canvas per il waveform
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        
                        // Imposta le dimensioni
                        canvas.width = container.clientWidth;
                        canvas.height = 100;
                        
                        // Disegna il waveform
                        ctx.fillStyle = '#ff2e88';
                        const barWidth = canvas.width / waveformData.length;
                        const multiplier = canvas.height / 2;
                        
                        waveformData.forEach((amplitude, i) => {
                            const x = i * barWidth;
                            const height = amplitude * multiplier;
                            ctx.fillRect(x, (canvas.height - height) / 2, barWidth - 1, height);
                        });
                        
                        container.appendChild(canvas);
                    });
                </script>
            {% endif %}
        {% else %}
            <div class="embed-responsive embed-responsive-16by9">
                {% if demo.get_platform == 'youtube' %}
                    <iframe class="embed-responsive-item" 
                            src="{{ demo.external_audio_url|youtube_embed_url }}" 
                            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                            allowfullscreen></iframe>
                {% elif demo.get_platform == 'soundcloud' %}
                    <iframe class="embed-responsive-item" 
                            src="https://w.soundcloud.com/player/?url={{ demo.external_audio_url }}&color=%23ff2e88"
                            allow="autoplay"></iframe>
                {% elif demo.get_platform == 'spotify' %}
                    <iframe class="embed-responsive-item" 
                            src="{{ demo.external_audio_url|spotify_embed_url }}"
                            allow="encrypted-media"></iframe>
                {% else %}
                    <div class="alert alert-info">
                        <i class="bi bi-music-note"></i>
                        Audio disponibile su: <a href="{{ demo.external_audio_url }}" target="_blank" class="alert-link">{{ demo.get_platform|title }}</a>
                    </div>
                {% endif %}
            </div>
        {% endif %}
        
        <div class="mt-3 d-flex justify-content-between align-items-center">
            <div>
                <span class="badge bg-primary">{{ demo.genre }}</span>
                {% if demo.duration %}
                    <small class="text-muted ms-2">
                        <i class="bi bi-clock"></i> {{ demo.duration }}
                    </small>
                {% endif %}
            </div>
            
            {% if demo.description %}
                <button class="btn btn-sm btn-outline-light" 
                        type="button" 
                        data-bs-toggle="collapse" 
                        data-bs-target="#demo-desc-{{ demo.id }}">
                    <i class="bi bi-info-circle"></i> Info
                </button>
            {% endif %}
        </div>
        
        {% if demo.description %}
            <div class="collapse mt-3" id="demo-desc-{{ demo.id }}">
                <div class="card card-body bg-dark border-secondary">
                    {{ demo.description|linebreaks }}
                </div>
            </div>
        {% endif %}
    </div>
</div>

{% extends 'base.html' %}
{% block title %}Prenota con {{ associate.user.get_full_name }} - MyLabel{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <!-- Associate Info Sidebar -->
        <div class="col-lg-3">
            <div class="card sticky-top" style="top: 100px;">
                <div class="card-body text-center">
                    <img src="{{ associate.user.profile.get_avatar_url }}" alt="Avatar" 
                         class="rounded-circle mb-3" style="width: 100px; height: 100px; object-fit: cover; border: 3px solid var(--primary-blue);">
                    
                    <h5 class="text-light">{{ associate.user.get_full_name }}</h5>
                    <p class="text-success mb-2">{{ associate.specialization }}</p>
                    
                    {% if associate.hourly_rate %}
                    <div class="alert alert-success py-2 mb-3">
                        <strong><i class="bi bi-currency-euro"></i> {{ associate.get_rate_display }}</strong>
                    </div>
                    {% endif %}
                    
                    {% if associate.years_experience %}
                    <p class="text-muted small mb-2">
                        <i class="bi bi-award"></i> {{ associate.years_experience }} anni esperienza
                    </p>
                    {% endif %}
                    
                    {% if associate.availability %}
                    <p class="text-muted small mb-3">
                        <i class="bi bi-clock"></i> {{ associate.availability }}
                    </p>
                    {% endif %}
                    
                    <div class="mb-3">
                        {% if associate.is_available %}
                        <span class="badge bg-success">
                            <i class="bi bi-check-circle"></i> Disponibile
                        </span>
                        {% else %}
                        <span class="badge bg-warning">
                            <i class="bi bi-clock"></i> Occupato
                        </span>
                        {% endif %}
                    </div>
                    
                    <div class="d-grid gap-2">
                        <a href="{% url 'associates:detail' associate.pk %}" class="btn btn-outline-primary btn-sm">
                            <i class="bi bi-person"></i> Vedi Profilo
                        </a>
                        <a href="{% url 'messaging:send' associate.user.id %}" class="btn btn-outline-success btn-sm">
                            <i class="bi bi-chat"></i> Messaggio
                        </a>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Booking Calendar -->
        <div class="col-lg-9">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h4 class="text-light mb-0">
                            <i class="bi bi-calendar-plus"></i> Prenota Sessione
                        </h4>
                        <div class="d-flex gap-2">
                            <button class="btn btn-outline-primary btn-sm" onclick="previousWeek()">
                                <i class="bi bi-chevron-left"></i>
                            </button>
                            <span id="current-week-display" class="text-light px-3 py-1 rounded bg-primary"></span>
                            <button class="btn btn-outline-primary btn-sm" onclick="nextWeek()">
                                <i class="bi bi-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="card-body">
                    <!-- Calendar Legend -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="d-flex justify-content-center gap-4 flex-wrap">
                                <div class="d-flex align-items-center">
                                    <div class="legend-box available"></div>
                                    <span class="text-light ms-2">Disponibile</span>
                                </div>
                                <div class="d-flex align-items-center">
                                    <div class="legend-box booked"></div>
                                    <span class="text-light ms-2">Prenotato</span>
                                </div>
                                <div class="d-flex align-items-center">
                                    <div class="legend-box pending"></div>
                                    <span class="text-light ms-2">In Attesa</span>
                                </div>
                                <div class="d-flex align-items-center">
                                    <div class="legend-box selected"></div>
                                    <span class="text-light ms-2">Selezionato</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Calendar Grid -->
                    <div class="booking-calendar">
                        <div class="calendar-header">
                            <div class="time-column">Ora</div>
                            <div class="day-column">Lun <span id="day-0"></span></div>
                            <div class="day-column">Mar <span id="day-1"></span></div>
                            <div class="day-column">Mer <span id="day-2"></span></div>
                            <div class="day-column">Gio <span id="day-3"></span></div>
                            <div class="day-column">Ven <span id="day-4"></span></div>
                            <div class="day-column">Sab <span id="day-5"></span></div>
                            <div class="day-column">Dom <span id="day-6"></span></div>
                        </div>
                        <div id="calendar-body" class="calendar-body">
                            <!-- Populated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Selected Booking Details -->
            <div class="card mt-4" id="booking-details" style="display: none;">
                <div class="card-header bg-primary">
                    <h5 class="mb-0 text-white">
                        <i class="bi bi-check-circle"></i> Dettagli Prenotazione
                    </h5>
                </div>
                <div class="card-body">
                    <form id="booking-form">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="booking-summary p-3 bg-dark rounded mb-3">
                                    <h6 class="text-light mb-2">Riepilogo:</h6>
                                    <div class="d-flex justify-content-between mb-1">
                                        <span>Data:</span>
                                        <strong id="selected-date" class="text-primary"></strong>
                                    </div>
                                    <div class="d-flex justify-content-between mb-1">
                                        <span>Orario:</span>
                                        <strong id="selected-time" class="text-success"></strong>
                                    </div>
                                    <div class="d-flex justify-content-between mb-1">
                                        <span>Durata:</span>
                                        <strong id="selected-duration" class="text-warning">2 ore</strong>
                                    </div>
                                    <hr>
                                    <div class="d-flex justify-content-between">
                                        <span>Costo Totale:</span>
                                        <strong id="total-cost" class="text-light fs-5">€{{ associate.hourly_rate|default:0|floatformat:0 }}0</strong>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label text-light">Durata Sessione</label>
                                    <select class="form-select" id="duration-select" onchange="updateCost()">
                                        <option value="1">1 ora</option>
                                        <option value="2" selected>2 ore</option>
                                        <option value="3">3 ore</option>
                                        <option value="4">4 ore</option>
                                        <option value="6">6 ore</option>
                                        <option value="8">8 ore</option>
                                    </select>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label text-light">Tipo Sessione</label>
                                    <select class="form-select" id="booking-type">
                                        <option value="recording">Registrazione</option>
                                        <option value="mixing">Mixing</option>
                                        <option value="mastering">Mastering</option>
                                        <option value="production">Produzione</option>
                                        <option value="lesson">Lezione</option>
                                        <option value="consultation">Consulenza</option>
                                        <option value="other">Altro</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label text-light">Località</label>
                                <input type="text" class="form-control" id="location" 
                                       placeholder="Studio, indirizzo o 'da definire'">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label text-light">Metodo Pagamento</label>
                                <select class="form-select" id="payment-method">
                                    <option value="card">Carta di Credito</option>
                                    <option value="paypal">PayPal</option>
                                    <option value="bank">Bonifico Bancario</option>
                                    <option value="cash">Contanti (al momento)</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <label class="form-label text-light">Note aggiuntive</label>
                            <textarea class="form-control" id="notes" rows="3" 
                                      placeholder="Dettagli sulla sessione, richieste speciali, equipaggiamento necessario..."></textarea>
                        </div>
                        
                        <!-- Payment Options -->
                        <div class="payment-options mb-4">
                            <h6 class="text-light mb-3">Opzioni Pagamento:</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="payment-timing" id="pay-full" value="full" checked>
                                        <label class="form-check-label text-light" for="pay-full">
                                            <strong>Pagamento Completo</strong><br>
                                            <small class="text-success">Conferma immediata + 5% sconto</small>
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="payment-timing" id="pay-deposit" value="deposit">
                                        <label class="form-check-label text-light" for="pay-deposit">
                                            <strong>Acconto 30%</strong><br>
                                            <small class="text-warning">Resto al completamento</small>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Terms and Conditions -->
                        <div class="alert alert-info">
                            <h6><i class="bi bi-info-circle"></i> Termini e Condizioni:</h6>
                            <ul class="mb-0 small">
                                <li><strong>Cancellazione:</strong> Gratuita fino a 48h prima, dopo 50% penale</li>
                                <li><strong>Modifica:</strong> Possibile fino a 24h prima (soggetta a disponibilità)</li>
                                <li><strong>Rimborso:</strong> In caso di cancellazione del professionista: 100%</li>
                                <li><strong>No-Show:</strong> Nessun rimborso per mancata presentazione</li>
                            </ul>
                        </div>
                        
                        <div class="form-check mb-4">
                            <input class="form-check-input" type="checkbox" id="terms-accepted" required>
                            <label class="form-check-label text-light" for="terms-accepted">
                                Accetto i <a href="#" class="text-primary">termini e condizioni</a> e la 
                                <a href="#" class="text-primary">politica di cancellazione</a>
                            </label>
                        </div>
                        
                        <div class="d-flex gap-2 justify-content-between">
                            <button type="button" class="btn btn-outline-light" onclick="cancelBooking()">
                                <i class="bi bi-x-circle"></i> Annulla
                            </button>
                            
                            <div class="d-flex gap-2">
                                <button type="button" class="btn btn-warning" onclick="saveAsDraft()">
                                    <i class="bi bi-bookmark"></i> Salva Bozza
                                </button>
                                <button type="button" class="btn btn-success btn-lg" onclick="proceedToPayment()">
                                    <i class="bi bi-credit-card"></i> Procedi al Pagamento
                                    <span id="payment-amount"></span>
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.booking-calendar {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 0.75rem;
    overflow: hidden;
}

.calendar-header {
    display: grid;
    grid-template-columns: 80px repeat(7, 1fr);
    background: linear-gradient(135deg, var(--primary-blue), var(--secondary-green));
    color: white;
    font-weight: 600;
}

.time-column, .day-column {
    padding: 1rem;
    text-align: center;
    border-right: 1px solid rgba(255,255,255,0.2);
    position: relative;
}

.day-column span {
    display: block;
    font-size: 0.8rem;
    font-weight: 400;
    opacity: 0.8;
}

.calendar-body {
    display: grid;
    grid-template-columns: 80px repeat(7, 1fr);
}

.time-slot, .booking-cell {
    padding: 0.75rem;
    border-right: 1px solid var(--border);
    border-bottom: 1px solid var(--border);
    min-height: 60px;
    position: relative;
    transition: all 0.2s ease;
}

.time-slot {
    background: var(--bg-surface);
    color: var(--text-secondary);
    font-size: 0.85rem;
    font-weight: 500;
    text-align: center;
    display: flex;
    align-items: center;
    justify-content: center;
}

.booking-cell {
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.8rem;
    color: var(--text-muted);
}

.booking-cell:hover {
    background: rgba(59, 130, 246, 0.1);
    transform: scale(1.02);
}

.booking-cell.available {
    background: rgba(16, 185, 129, 0.15);
    border: 1px solid rgba(16, 185, 129, 0.3);
    color: var(--secondary-green);
    cursor: pointer;
}

.booking-cell.available:hover {
    background: rgba(16, 185, 129, 0.25);
    transform: scale(1.05);
}

.booking-cell.booked {
    background: rgba(239, 68, 68, 0.15);
    border: 1px solid rgba(239, 68, 68, 0.3);
    color: #ef4444;
    cursor: not-allowed;
}

.booking-cell.pending {
    background: rgba(245, 158, 11, 0.15);
    border: 1px solid rgba(245, 158, 11, 0.3);
    color: var(--accent-orange);
    cursor: not-allowed;
}

.booking-cell.selected {
    background: linear-gradient(135deg, var(--primary-blue), var(--secondary-green));
    color: white;
    font-weight: bold;
    animation: pulse-select 1s ease-in-out infinite alternate;
}

@keyframes pulse-select {
    from { box-shadow: 0 0 10px rgba(59, 130, 246, 0.5); }
    to { box-shadow: 0 0 20px rgba(16, 185, 129, 0.8); }
}

.legend-box {
    width: 20px;
    height: 20px;
    border-radius: 4px;
    display: inline-block;
    border: 1px solid var(--border);
}

.legend-box.available {
    background: rgba(16, 185, 129, 0.3);
    border-color: var(--secondary-green);
}

.legend-box.booked {
    background: rgba(239, 68, 68, 0.3);
    border-color: #ef4444;
}

.legend-box.pending {
    background: rgba(245, 158, 11, 0.3);
    border-color: var(--accent-orange);
}

.legend-box.selected {
    background: linear-gradient(135deg, var(--primary-blue), var(--secondary-green));
}

.booking-summary {
    border: 1px solid var(--primary-blue);
    box-shadow: 0 5px 15px rgba(59, 130, 246, 0.2);
}

.payment-options .form-check {
    padding: 1rem;
    border: 1px solid var(--border);
    border-radius: 0.5rem;
    margin-bottom: 0.5rem;
    transition: all 0.3s ease;
}

.payment-options .form-check:hover {
    border-color: var(--primary-blue);
    background: rgba(59, 130, 246, 0.05);
}

.payment-options .form-check input:checked ~ label {
    color: var(--primary-blue) !important;
}

.form-control, .form-select {
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid var(--border);
    color: var(--text-primary);
    border-radius: 0.5rem;
}

.form-control:focus, .form-select:focus {
    background: rgba(255, 255, 255, 0.15);
    border-color: var(--primary-blue);
    color: var(--text-primary);
    box-shadow: 0 0 0 0.25rem rgba(59, 130, 246, 0.25);
}

@media (max-width: 768px) {
    .calendar-header {
        font-size: 0.8rem;
    }
    
    .time-column, .day-column, .booking-cell {
        padding: 0.5rem;
        min-height: 50px;
    }
    
    .day-column span {
        font-size: 0.7rem;
    }
}
</style>

<script>
let currentWeek = new Date();
let selectedSlot = null;
let associateRate = {{ associate.hourly_rate|default:0 }};

document.addEventListener('DOMContentLoaded', function() {
    updateWeekDisplay();
    generateCalendar();
    loadAvailability();
    updatePaymentAmount();
});

function updateWeekDisplay() {
    const startOfWeek = getStartOfWeek(currentWeek);
    const endOfWeek = new Date(startOfWeek);
    endOfWeek.setDate(startOfWeek.getDate() + 6);
    
    const options = { day: 'numeric', month: 'short' };
    const weekText = `${startOfWeek.toLocaleDateString('it-IT', options)} - ${endOfWeek.toLocaleDateString('it-IT', options)}`;
    document.getElementById('current-week-display').textContent = weekText;
    
    // Update day headers
    for (let i = 0; i < 7; i++) {
        const date = new Date(startOfWeek);
        date.setDate(startOfWeek.getDate() + i);
        document.getElementById(`day-${i}`).textContent = date.getDate();
    }
}

function getStartOfWeek(date) {
    const d = new Date(date);
    const day = d.getDay();
    const diff = d.getDate() - day + (day === 0 ? -6 : 1);
    return new Date(d.setDate(diff));
}

function previousWeek() {
    currentWeek.setDate(currentWeek.getDate() - 7);
    updateWeekDisplay();
    generateCalendar();
    loadAvailability();
    hideBookingDetails();
}

function nextWeek() {
    currentWeek.setDate(currentWeek.getDate() + 7);
    updateWeekDisplay();
    generateCalendar();
    loadAvailability();
    hideBookingDetails();
}

function generateCalendar() {
    const calendarBody = document.getElementById('calendar-body');
    calendarBody.innerHTML = '';
    
    // Generate time slots (9:00 - 20:00)
    for (let hour = 9; hour <= 20; hour++) {
        // Time column
        const timeSlot = document.createElement('div');
        timeSlot.className = 'time-slot';
        timeSlot.textContent = `${hour.toString().padStart(2, '0')}:00`;
        calendarBody.appendChild(timeSlot);
        
        // Day columns
        for (let day = 0; day < 7; day++) {
            const cell = document.createElement('div');
            cell.className = 'booking-cell';
            cell.dataset.day = day;
            cell.dataset.hour = hour;
            cell.dataset.date = getDateForDayHour(day, hour).toISOString().split('T')[0];
            cell.onclick = () => handleSlotClick(day, hour, cell);
            calendarBody.appendChild(cell);
        }
    }
}

function handleSlotClick(day, hour, cell) {
    if (cell.classList.contains('booked') || cell.classList.contains('pending')) {
        return; // Can't select unavailable slots
    }
    
    if (!cell.classList.contains('available')) {
        return; // Can only select available slots
    }
    
    // Clear previous selection
    document.querySelectorAll('.booking-cell.selected').forEach(c => {
        c.classList.remove('selected');
    });
    
    // Select new slot
    cell.classList.add('selected');
    selectedSlot = {
        day: day,
        hour: hour,
        date: cell.dataset.date,
        cell: cell
    };
    
    updateBookingDetails();
    showBookingDetails();
}

function updateBookingDetails() {
    if (!selectedSlot) return;
    
    const date = new Date(selectedSlot.date);
    const dateStr = date.toLocaleDateString('it-IT', {
        weekday: 'long',
        day: 'numeric',
        month: 'long'
    });
    const timeStr = `${selectedSlot.hour.toString().padStart(2, '0')}:00`;
    
    document.getElementById('selected-date').textContent = dateStr;
    document.getElementById('selected-time').textContent = timeStr;
    
    updateCost();
}

function updateCost() {
    const duration = parseInt(document.getElementById('duration-select').value);
    const baseCost = associateRate * duration;
    const paymentOption = document.querySelector('input[name="payment-timing"]:checked').value;
    
    let finalCost = baseCost;
    let discount = 0;
    
    if (paymentOption === 'full') {
        discount = baseCost * 0.05; // 5% discount for full payment
        finalCost = baseCost - discount;
    }
    
    document.getElementById('selected-duration').textContent = `${duration} ore`;
    document.getElementById('total-cost').textContent = `€${finalCost.toFixed(2)}`;
    
    updatePaymentAmount();
}

function updatePaymentAmount() {
    const paymentOption = document.querySelector('input[name="payment-timing"]:checked')?.value || 'full';
    const totalCost = parseFloat(document.getElementById('total-cost').textContent.replace('€', ''));
    
    let paymentAmount = totalCost;
    if (paymentOption === 'deposit') {
        paymentAmount = totalCost * 0.3; // 30% deposit
    }
    
    document.getElementById('payment-amount').textContent = ` (€${paymentAmount.toFixed(2)})`;
}

function showBookingDetails() {
    document.getElementById('booking-details').style.display = 'block';
    document.getElementById('booking-details').scrollIntoView({
        behavior: 'smooth',
        block: 'start'
    });
}

function hideBookingDetails() {
    document.getElementById('booking-details').style.display = 'none';
    selectedSlot = null;
    
    // Clear selection
    document.querySelectorAll('.booking-cell.selected').forEach(c => {
        c.classList.remove('selected');
    });
}

function loadAvailability() {
    const startDate = getStartOfWeek(currentWeek).toISOString().split('T')[0];
    
    fetch(`/api/associates/{{ associate.id }}/availability/?week=${startDate}`)
        .then(response => response.json())
        .then(data => {
            // Clear previous states
            document.querySelectorAll('.booking-cell').forEach(cell => {
                cell.className = 'booking-cell';
                cell.textContent = '';
                cell.title = '';
            });
            
            // Mark available slots
            data.available_slots.forEach(slot => {
                const cell = document.querySelector(`[data-day="${slot.day}"][data-hour="${slot.hour}"]`);
                if (cell) {
                    cell.classList.add('available');
                    cell.textContent = 'Disponibile';
                    cell.title = 'Clicca per prenotare';
                }
            });
            
            // Mark booked slots
            data.bookings.forEach(booking => {
                const bookingDate = new Date(booking.session_date);
                const day = bookingDate.getDay() === 0 ? 6 : bookingDate.getDay() - 1; // Adjust for Monday start
                const hour = bookingDate.getHours();
                
                const cell = document.querySelector(`[data-day="${day}"][data-hour="${hour}"]`);
                if (cell) {
                    if (booking.status === 'confirmed') {
                        cell.classList.add('booked');
                        cell.textContent = 'Prenotato';
                        cell.title = `Prenotato da ${booking.artist_name}`;
                    } else if (booking.status === 'pending') {
                        cell.classList.add('pending');
                        cell.textContent = 'In Attesa';
                        cell.title = `In attesa di conferma - ${booking.artist_name}`;
                    }
                }
            });
        })
        .catch(error => {
            console.error('Error loading availability:', error);
        });
}

function getDateForDayHour(day, hour) {
    const startOfWeek = getStartOfWeek(currentWeek);
    const date = new Date(startOfWeek);
    date.setDate(startOfWeek.getDate() + day);
    date.setHours(hour, 0, 0, 0);
    return date;
}

function cancelBooking() {
    hideBookingDetails();
}

function saveAsDraft() {
    if (!selectedSlot) {
        alert('Seleziona prima uno slot disponibile');
        return;
    }
    
    const bookingData = gatherBookingData();
    bookingData.status = 'draft';
    
    // Save to localStorage
    localStorage.setItem('booking-draft', JSON.stringify(bookingData));
    alert('Bozza salvata! Potrai completarla in seguito.');
}

function proceedToPayment() {
    if (!selectedSlot) {
        alert('Seleziona prima uno slot disponibile');
        return;
    }
    
    if (!document.getElementById('terms-accepted').checked) {
        alert('Devi accettare i termini e condizioni');
        return;
    }
    
    const bookingData = gatherBookingData();
    
    // Simulate payment process
    showPaymentModal(bookingData);
}

function gatherBookingData() {
    return {
        associate_id: {{ associate.id }},
        session_date: selectedSlot.date,
        session_time: `${selectedSlot.hour.toString().padStart(2, '0')}:00`,
        duration_hours: parseInt(document.getElementById('duration-select').value),
        booking_type: document.getElementById('booking-type').value,
        location: document.getElementById('location').value,
        notes: document.getElementById('notes').value,
        payment_method: document.getElementById('payment-method').value,
        payment_timing: document.querySelector('input[name="payment-timing"]:checked').value,
        total_cost: parseFloat(document.getElementById('total-cost').textContent.replace('€', ''))
    };
}

function showPaymentModal(bookingData) {
    // Create and show payment modal
    const modal = document.createElement('div');
    modal.className = 'modal fade show';
    modal.style.display = 'block';
    modal.innerHTML = `
        <div class="modal-dialog">
            <div class="modal-content bg-dark">
                <div class="modal-header">
                    <h5 class="modal-title text-light">
                        <i class="bi bi-credit-card"></i> Pagamento Sicuro
                    </h5>
                </div>
                <div class="modal-body">
                    <div class="payment-summary p-3 bg-primary rounded mb-3">
                        <h6 class="text-white">Riepilogo Pagamento:</h6>
                        <div class="d-flex justify-content-between">
                            <span>${bookingData.duration_hours} ore con ${document.querySelector('#associate-name').textContent || '{{ associate.user.get_full_name }}'}</span>
                            <strong>€${bookingData.total_cost.toFixed(2)}</strong>
                        </div>
                    </div>
                    
                    <div class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Processing...</span>
                        </div>
                        <p class="text-light mt-2">Elaborazione pagamento sicuro...</p>
                    </div>
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    
    // Simulate payment processing
    setTimeout(() => {
        document.body.removeChild(modal);
        processBooking(bookingData);
    }, 3000);
}

function processBooking(bookingData) {
    fetch('/api/bookings/create/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify(bookingData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Show success modal
            alert('Prenotazione confermata con successo!\nRiceverai una email di conferma a breve.');
            window.location.href = `/booking/${data.booking_id}/`;
        } else {
            alert('Errore nella prenotazione: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Errore nella prenotazione. Riprova più tardi.');
    });
}

// Event listeners for payment options
document.addEventListener('change', function(e) {
    if (e.target.name === 'payment-timing') {
        updateCost();
    }
});

// Load draft if exists
document.addEventListener('DOMContentLoaded', function() {
    const draft = localStorage.getItem('booking-draft');
    if (draft) {
        const draftData = JSON.parse(draft);
        // Auto-fill form with draft data
        // ... implementation depends on your needs
    }
});
</script>
{% endblock %}